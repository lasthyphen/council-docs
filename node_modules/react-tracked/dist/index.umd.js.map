{"version":3,"file":"index.umd.js","sources":["../src/utils.ts","../src/createTrackedSelector.ts","../src/createContainer.ts","../src/memo.ts"],"sourcesContent":["import { useEffect, useRef, useDebugValue } from 'react';\nimport { affectedToPathList } from 'proxy-compare';\n\ntype Obj = Record<string, unknown>;\n\nexport const useAffectedDebugValue = <State>(\n  state: State,\n  affected: WeakMap<Obj, unknown>,\n) => {\n  const pathList = useRef<(string | number | symbol)[][]>();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(state);\n};\n","import {\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n} from 'react';\nimport { createProxy, isChanged } from 'proxy-compare';\n\nimport { useAffectedDebugValue } from './utils';\n\nexport const createTrackedSelector = <State>(\n  useSelector: <Selected>(selector: (state: State) => Selected) => Selected,\n) => {\n  const useTrackedSelector = () => {\n    const [, forceUpdate] = useReducer((c) => c + 1, 0);\n    const affected = new WeakMap();\n    const lastAffected = useRef<typeof affected>();\n    const prevState = useRef<State>();\n    const lastState = useRef<State>();\n    useEffect(() => {\n      lastAffected.current = affected;\n      if (prevState.current !== lastState.current\n        && isChanged(\n          prevState.current,\n          lastState.current,\n          affected,\n          new WeakMap(),\n        )) {\n        prevState.current = lastState.current;\n        forceUpdate();\n      }\n    });\n    const selector = useCallback((nextState: State) => {\n      lastState.current = nextState;\n      if (prevState.current\n        && prevState.current !== nextState\n        && lastAffected.current\n        && !isChanged(\n          prevState.current,\n          nextState,\n          lastAffected.current,\n          new WeakMap(),\n        )\n      ) {\n        // not changed\n        return prevState.current;\n      }\n      prevState.current = nextState;\n      return nextState;\n    }, []);\n    const state = useSelector(selector);\n    if (typeof process === 'object' && process.env.NODE_ENV !== 'production') {\n      // eslint-disable-next-line react-hooks/rules-of-hooks\n      useAffectedDebugValue(state, affected);\n    }\n    const proxyCache = useMemo(() => new WeakMap(), []); // per-hook proxyCache\n    return createProxy(state, affected, proxyCache);\n  };\n  return useTrackedSelector;\n};\n","/* eslint react/destructuring-assignment: off */\n\nimport {\n  FC,\n  createContext as createContextOrig,\n  createElement,\n  useCallback,\n  useContext as useContextOrig,\n  useDebugValue,\n} from 'react';\n\nimport {\n  Context,\n  createContext,\n  useContextSelector,\n  useContextUpdate,\n} from 'use-context-selector';\n\nimport { createTrackedSelector } from './createTrackedSelector';\n\nconst warningObject = new Proxy({}, {\n  get() { throw new Error('Please use <Provider>'); },\n  apply() { throw new Error('Please use <Provider>'); },\n});\n\ntype AnyFunction = (...args: any[]) => any;\n\nexport const createContainer = <State, Update extends AnyFunction, Props>(\n  useValue: (props: Props) => readonly [State, Update],\n  concurrentMode = false,\n) => {\n  const StateContext = createContext(warningObject as State);\n  const UpdateContext = createContextOrig(warningObject as Update);\n\n  const Provider: FC<Props> = (props) => {\n    const [state, update] = useValue(props);\n    return createElement(UpdateContext.Provider, { value: update },\n      createElement(StateContext.Provider, { value: state }, props.children));\n  };\n\n  const useSelector = <Selected>(\n    selector: (state: State) => Selected,\n  ) => {\n    const selected = useContextSelector(StateContext, selector);\n    useDebugValue(selected);\n    return selected;\n  };\n\n  const useTrackedState = createTrackedSelector(useSelector);\n\n  const useUpdate = concurrentMode\n    ? () => {\n      const contextUpdate = useContextUpdate(StateContext as Context<unknown>);\n      const update = useContextOrig(UpdateContext);\n      return useCallback((...args: Parameters<Update>) => {\n        let result: ReturnType<Update> | undefined;\n        contextUpdate(() => {\n          result = update(...args);\n        });\n        return result as ReturnType<Update>;\n      }, [contextUpdate, update]);\n    }\n    // not concurrentMode\n    : () => useContextOrig(UpdateContext);\n\n  const useTracked = () => [useTrackedState(), useUpdate()] as [\n    ReturnType<typeof useTrackedState>,\n    ReturnType<typeof useUpdate>,\n  ];\n\n  return {\n    Provider,\n    useTrackedState,\n    useTracked,\n    useUpdate,\n    useSelector,\n  } as const;\n};\n","import { createElement, memo as reactMemo, forwardRef } from 'react';\nimport { trackMemo } from 'proxy-compare';\n\nimport type {\n  FC,\n  PropsWithChildren,\n  NamedExoticComponent,\n  ComponentType,\n  ComponentProps,\n  MemoExoticComponent,\n} from 'react';\n\nexport function memo<P extends Record<string, unknown>>(\n  Component: FC<P>,\n  propsAreEqual?: (\n    prevProps: Readonly<PropsWithChildren<P>>,\n    nextProps: Readonly<PropsWithChildren<P>>,\n  ) => boolean,\n): NamedExoticComponent<P>;\n\nexport function memo<T extends ComponentType<any>>(\n  Component: T,\n  propsAreEqual?: (\n    prevProps: Readonly<ComponentProps<T>>,\n    nextProps: Readonly<ComponentProps<T>>,\n  ) => boolean,\n): MemoExoticComponent<T>;\n\nexport function memo(Component: any, propsAreEqual?: any) {\n  const WrappedComponent = forwardRef((props: any, ref: any) => {\n    Object.values(props).forEach(trackMemo);\n    return createElement(Component, { ...props, ref });\n  });\n  return reactMemo(WrappedComponent, propsAreEqual);\n}\n"],"names":["useAffectedDebugValue","state","affected","pathList","useRef","useEffect","current","affectedToPathList","useDebugValue","createTrackedSelector","useSelector","useTrackedSelector","useReducer","c","forceUpdate","WeakMap","lastAffected","prevState","lastState","isChanged","selector","useCallback","nextState","process","env","NODE_ENV","proxyCache","useMemo","createProxy","warningObject","Proxy","get","Error","apply","createContainer","useValue","concurrentMode","StateContext","createContext","UpdateContext","createContextOrig","Provider","props","update","createElement","value","children","selected","useContextSelector","useTrackedState","useUpdate","contextUpdate","useContextUpdate","useContextOrig","result","useTracked","memo","Component","propsAreEqual","WrappedComponent","forwardRef","ref","Object","values","forEach","trackMemo","reactMemo"],"mappings":";;;;;EAKO,IAAMA,qBAAqB,GAAG,SAAxBA,qBAAwB,CACnCC,KADmC,EAEnCC,QAFmC;EAInC,MAAMC,QAAQ,GAAGC,YAAM,EAAvB;EACAC,EAAAA,eAAS,CAAC;EACRF,IAAAA,QAAQ,CAACG,OAAT,GAAmBC,+BAAkB,CAACN,KAAD,EAAQC,QAAR,CAArC;EACD,GAFQ,CAAT;EAGAM,EAAAA,mBAAa,CAACP,KAAD,CAAb;EACD,CATM;;MCMMQ,qBAAqB,GAAG,SAAxBA,qBAAwB,CACnCC,WADmC;EAGnC,MAAMC,kBAAkB,GAAG,SAArBA,kBAAqB;EACzB,sBAAwBC,gBAAU,CAAC,UAACC,CAAD;EAAA,aAAOA,CAAC,GAAG,CAAX;EAAA,KAAD,EAAe,CAAf,CAAlC;EAAA,QAASC,WAAT;;EACA,QAAMZ,QAAQ,GAAG,IAAIa,OAAJ,EAAjB;EACA,QAAMC,YAAY,GAAGZ,YAAM,EAA3B;EACA,QAAMa,SAAS,GAAGb,YAAM,EAAxB;EACA,QAAMc,SAAS,GAAGd,YAAM,EAAxB;EACAC,IAAAA,eAAS,CAAC;EACRW,MAAAA,YAAY,CAACV,OAAb,GAAuBJ,QAAvB;;EACA,UAAIe,SAAS,CAACX,OAAV,KAAsBY,SAAS,CAACZ,OAAhC,IACCa,sBAAS,CACVF,SAAS,CAACX,OADA,EAEVY,SAAS,CAACZ,OAFA,EAGVJ,QAHU,EAIV,IAAIa,OAAJ,EAJU,CADd,EAMK;EACHE,QAAAA,SAAS,CAACX,OAAV,GAAoBY,SAAS,CAACZ,OAA9B;EACAQ,QAAAA,WAAW;EACZ;EACF,KAZQ,CAAT;EAaA,QAAMM,QAAQ,GAAGC,iBAAW,CAAC,UAACC,SAAD;EAC3BJ,MAAAA,SAAS,CAACZ,OAAV,GAAoBgB,SAApB;;EACA,UAAIL,SAAS,CAACX,OAAV,IACCW,SAAS,CAACX,OAAV,KAAsBgB,SADvB,IAECN,YAAY,CAACV,OAFd,IAGC,CAACa,sBAAS,CACXF,SAAS,CAACX,OADC,EAEXgB,SAFW,EAGXN,YAAY,CAACV,OAHF,EAIX,IAAIS,OAAJ,EAJW,CAHf,EASE;EACA;EACA,eAAOE,SAAS,CAACX,OAAjB;EACD;;EACDW,MAAAA,SAAS,CAACX,OAAV,GAAoBgB,SAApB;EACA,aAAOA,SAAP;EACD,KAjB2B,EAiBzB,EAjByB,CAA5B;EAkBA,QAAMrB,KAAK,GAAGS,WAAW,CAACU,QAAD,CAAzB;;EACA,QAAI,OAAOG,OAAP,KAAmB,QAAnB,IAA+BA,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAA5D,EAA0E;EACxE;EACAzB,MAAAA,qBAAqB,CAACC,KAAD,EAAQC,QAAR,CAArB;EACD;;EACD,QAAMwB,UAAU,GAAGC,aAAO,CAAC;EAAA,aAAM,IAAIZ,OAAJ,EAAN;EAAA,KAAD,EAAsB,EAAtB,CAA1B;;EACA,WAAOa,wBAAW,CAAC3B,KAAD,EAAQC,QAAR,EAAkBwB,UAAlB,CAAlB;EACD,GA5CD;;EA6CA,SAAOf,kBAAP;EACD;;EC5DD;EAoBA,IAAMkB,aAAa,GAAG,IAAIC,KAAJ,CAAU,EAAV,EAAc;EAClCC,EAAAA,GADkC;EAC1B,UAAM,IAAIC,KAAJ,CAAU,uBAAV,CAAN;EAA2C,GADjB;EAElCC,EAAAA,KAFkC;EAExB,UAAM,IAAID,KAAJ,CAAU,uBAAV,CAAN;EAA2C;EAFnB,CAAd,CAAtB;MAOaE,eAAe,GAAG,SAAlBA,eAAkB,CAC7BC,QAD6B,EAE7BC,cAF6B;QAE7BA;EAAAA,IAAAA,iBAAiB;;;EAEjB,MAAMC,YAAY,GAAGC,gCAAa,CAACT,aAAD,CAAlC;EACA,MAAMU,aAAa,GAAGC,mBAAiB,CAACX,aAAD,CAAvC;;EAEA,MAAMY,QAAQ,GAAc,SAAtBA,QAAsB,CAACC,KAAD;EAC1B,oBAAwBP,QAAQ,CAACO,KAAD,CAAhC;EAAA,QAAOzC,KAAP;EAAA,QAAc0C,MAAd;;EACA,WAAOC,mBAAa,CAACL,aAAa,CAACE,QAAf,EAAyB;EAAEI,MAAAA,KAAK,EAAEF;EAAT,KAAzB,EAClBC,mBAAa,CAACP,YAAY,CAACI,QAAd,EAAwB;EAAEI,MAAAA,KAAK,EAAE5C;EAAT,KAAxB,EAA0CyC,KAAK,CAACI,QAAhD,CADK,CAApB;EAED,GAJD;;EAMA,MAAMpC,WAAW,GAAG,SAAdA,WAAc,CAClBU,QADkB;EAGlB,QAAM2B,QAAQ,GAAGC,qCAAkB,CAACX,YAAD,EAAejB,QAAf,CAAnC;EACAZ,IAAAA,mBAAa,CAACuC,QAAD,CAAb;EACA,WAAOA,QAAP;EACD,GAND;;EAQA,MAAME,eAAe,GAAGxC,qBAAqB,CAACC,WAAD,CAA7C;EAEA,MAAMwC,SAAS,GAAGd,cAAc,GAC5B;EACA,QAAMe,aAAa,GAAGC,mCAAgB,CAACf,YAAD,CAAtC;EACA,QAAMM,MAAM,GAAGU,gBAAc,CAACd,aAAD,CAA7B;EACA,WAAOlB,iBAAW,CAAC;;EACjB,UAAIiC,MAAJ;EACAH,MAAAA,aAAa,CAAC;EACZG,QAAAA,MAAM,GAAGX,MAAM,MAAN,mCAAT;EACD,OAFY,CAAb;EAGA,aAAOW,MAAP;EACD,KANiB,EAMf,CAACH,aAAD,EAAgBR,MAAhB,CANe,CAAlB;EAOD,GAX6B;EAAA,IAa5B;EAAA,WAAMU,gBAAc,CAACd,aAAD,CAApB;EAAA,GAbJ;;EAeA,MAAMgB,UAAU,GAAG,SAAbA,UAAa;EAAA,WAAM,CAACN,eAAe,EAAhB,EAAoBC,SAAS,EAA7B,CAAN;EAAA,GAAnB;;EAKA,SAAO;EACLT,IAAAA,QAAQ,EAARA,QADK;EAELQ,IAAAA,eAAe,EAAfA,eAFK;EAGLM,IAAAA,UAAU,EAAVA,UAHK;EAILL,IAAAA,SAAS,EAATA,SAJK;EAKLxC,IAAAA,WAAW,EAAXA;EALK,GAAP;EAOD;;;;;;;;;;;;;;;;;;;;WCjDe8C,KAAKC,WAAgBC;EACnC,MAAMC,gBAAgB,GAAGC,gBAAU,CAAC,UAAClB,KAAD,EAAamB,GAAb;EAClCC,IAAAA,MAAM,CAACC,MAAP,CAAcrB,KAAd,EAAqBsB,OAArB,CAA6BC,sBAA7B;EACA,WAAOrB,mBAAa,CAACa,SAAD,eAAiBf,KAAjB;EAAwBmB,MAAAA,GAAG,EAAHA;EAAxB,OAApB;EACD,GAHkC,CAAnC;EAIA,SAAOK,UAAS,CAACP,gBAAD,EAAmBD,aAAnB,CAAhB;EACD;;;;;;;;;;;;;;"}